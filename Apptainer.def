# Build an Apptainer SIF file containing a working copy of PySR and its prereqs
Bootstrap: docker
From: julia:{{ JULIA_VERSION }}-{{ JULIA_BASE_IMAGE }}
Stage: jl

%arguments
	JULIA_VERSION=1.10.4
	JULIA_BASE_IMAGE=bullseye

Bootstrap: docker
From: python:{{ PYTHON_VERSION }}-{{ BASE_IMAGE }}
Stage: runtime

%arguments
	PYTHON_VERSION=3.12
	BASE_IMAGE=bullseye

%environment
	# Use the container Julia binary
	export PATH="/usr/local/julia/bin:$PATH"

	# Create a stacked environment for additional Julia packages
	export JULIA_DEPOT_PATH="$HOME/.pysr:/pysr/depot:$JULIA_DEPOT_PATH"
	export JULIA_LOAD_PATH="$HOME/.pysr:/pysr:$JULIA_LOAD_PATH"

%files from jl
	/usr/local/julia /usr/local/julia

%files
	./requirements.txt /pysr/requirements.txt
	./pyproject.toml /pysr/pyproject.toml
	./setup.py /pysr/setup.py
	./pysr /pysr/pysr

%post
	cd /pysr

	export PATH="/usr/local/julia/bin:$PATH"

	# Install IPython and other useful libraries:
	pip3 install --no-cache-dir ipython matplotlib

	pip3 install --no-cache-dir -r ./requirements.txt

	# Install PySR:
	pip3 install --no-cache-dir .

	# Put the Julia dependencies in /pysr/depo
	mkdir /pysr/depot
	mkdir /pysr/env

	export JULIA_DEPOT_PATH="/pysr/depot:$JULIA_DEPOT_PATH"
	export PYTHON_JULIAPKG_PROJECT="/pysr/env"

	# Pull in all the Julia dependencies
	python3 -c 'import pysr; pysr.load_all_packages()'

%runscript
	# Start ipython when the container is executed
	[ ! -d $HOME/.pysr ] && mkdir $HOME/.pysr
	PYTHONPATH=/pysr ipython
